# 登录

```shell
curl --request POST \
  --url http://${ip} \
  --header 'Content-Type: application/x-www-form-urlencoded' \
  --data action=login \
  --data Frm_Logintoken=0 \
  --data username=${username} \
  --data textpwd=${password} \
  --data ieversion=1 \
  --data 'logincode=${logincode}'
```

其中 logincode 的计算方法为：使用 AES-CBC-PKCS7 的方法对 password 进行加密，key 为 "1111111111111111"，iv 为 "0000000000000000"。

登录后不会返回任何东西，会 302 重定向到 `/start.ghtml`，需要保持当前的连接为 keep-alive，如果连接断开了则返回内容会包含 `<form name="fLogin" id="fLogin"`。如果返回 `其他用户正在配置`，则需要等待一段时间。

# 获取设备型号

请求 GET http://${ip}/template.gch，返回内容为 HTML。通过这个模板匹配可以找到如下关键信息：`<td id="${key}" ...other attributes>${value}</td>`，其中 value 需要 html unescape。这里包含的 key 有：

| key               | 含义         |
|-------------------|--------------|
| Frm_CarrierName   | 运营商       |
| Frm_ModelName     | 设备型号     |
| Frm_SerialNumber  | 设备标识号   |
| Frm_HardwareVer   | 硬件版本号   |
| Frm_SoftwareVer   | 软件版本号   |
| Frm_BootVer       | BOOT 版本号  |

# 获取光模块信息

请求 GET http://192.168.1.1/getpage.gch?pid=1002&nextpage=gpon_status_link_info_t.gch，返回内容为 HTML。其中包含的一段如下：

```html
var RxPower = "-208600";
var TxPower = "41000";
var Current = "33236";

RxPower = parseFloat(RxPower/10000).toFixed(1);
TxPower = parseFloat(TxPower/10000).toFixed(1);

var Volt   = "3335000";
var Temp   = "67519";
```

这里面的信息为：
- 光模块输入功率：-20.86dBm
- 光模块输出功率：4.1dBm
- 光模块供电电压：3.3335V
- 光发送机偏置电流：33.236mA
- 光模块工作温度：67.519℃

另外是否连接可以查看这段代码

```html
Transfer_meaning('LoidState','1');
```

对应的状态枚举如下：

| 状态值 | 说明                             |
|--------|----------------------------------|
| 0      | 初始状态                         |
| 1      | 认证成功                         |
| 2      | 认证失败                         |
| 3      | LOID 存在，但密码错误             |
| 4      | LOID 冲突（已有该 LOID 的 ONU 认证成功） |
| 5      | 认证中                           |

# 获取 LAN 口信息

请求 GET http://${ip}/getpage.gch?pid=1002&nextpage=gpon_status_lan_info_t.gch，返回的内容为 HTML。由 4 个 LAN 口组成，每个 LAN 口的信息结构都是由多个 table 标签组成，如下：

```html
<table id="TestContent"  class="infor" width="410" border="0" cellpadding="0" cellspacing="1" bgcolor="#979797">
<tr class="white_1">
<td class="tdleft">端口名称</td>
<td class="tdright">LAN4</td>
</tr>
<tr class="blue_1">
<td class="tdleft">IPv4/v6地址</td>
<td class="tdright">192.168.1.1/fe80::1</td>
</tr>
<tr class="white_1">
<td class="tdleft">MAC地址</td>
<td class="tdright">FC:8D:13:00:00:00</td>
</tr>
<tr class="blue_1">
<td class="tdleft">状态</td>
<td class="tdright">已连接</td>
</tr>
<tr class="white_1">
<td class="tdleft">模式</td>
<td class="tdright">全双工</td>
</tr>
<tr class="blue_1">
<td class="tdleft">速率</td>
<td class="tdright">1000M</td>
</tr>
<tr class="white_1">
<td class="tdleft">收包数/字节数</td>
<td class="tdright">15820/2240217</td>
</tr>
<tr class="blue_1">
<td class="tdleft">发包数/字节数</td>
<td class="tdright">31196/4938596</td>
</tr>
<tr class="white_1">
<td class="tdleft">错误帧</td>
<td class="tdright">0</td>
</tr>
</table>
```

# 重启

分成两步：
1. 获取 session token；
  请求 `GET http://${ip}/getpage.gch?pid=1002&nextpage=manager_dev_restart_t.gch`，找到页面中 `var session_token = "xxxx";` 这样的代码并提取值出来。
2. 发送重启请求。
  ```shell
  curl --request POST \
    --url 'http://${ip}/getpage.gch?pid=1002&nextpage=manager_dev_restart_t.gch' \
    --header 'Content-Type: application/x-www-form-urlencoded' \
    --data IF_ACTION=devrestart \
    --data IF_ERRORSTR=SUCC \
    --data IF_ERRORPARAM=SUCC \
    --data IF_ERRORTYPE=2751496 \
    --data flag=1 \
    --data _SESSION_TOKEN=${session_token}
